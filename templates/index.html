{% extends "layout.html" %}

{% block title %}
Home
{% endblock %}

{% block main %}
<div id="div">
    <div class="container m-5">
        <div class="container m-5">
            <h1 id="home-header"></h1>
            <div class="row" id="index-row">

                <!--            <div class="col-sm-4">-->
                <!--                <div class="card my-2">-->
                <!--                    <div class="card-body home-set">-->
                <!--                        <h5>Title</h5>-->
                <!--                        <div class="card-text">-->
                <!--                            <p>5 Terms</p>-->
                <!--                            <p>Quiz</p>-->
                <!--                            <div class="row">-->
                <!--                                <div class="col-auto">-->
                <!--                                    <p id="home-edit">edit</p>-->
                <!--                                </div>-->
                <!--                                <div class="col-auto">-->
                <!--                                    <p>delete</p>-->
                <!--                                </div>-->
                <!--                            </div>-->
                <!--                        </div>-->
                <!--                    </div>-->
                <!--                </div>-->
                <!--            </div>-->

            </div>
        </div>
    </div>
</div>

<script>
    let headers = []
    let sets = 1

    document.body.onload = addElements

    async function addElements() {
        try {
            headers = await getSets()
            sets = headers.length
            let header = document.getElementById('home-header')
            header.innerText = "All (" + sets + ")"

            for (let i = 0; i < sets; i++) {
                let set = await openJson(headers[i])
                console.log("set: " + set)

                let newSetCol = document.createElement('div')
                newSetCol.classList.add('col-sm-4')

                let newSet = document.createElement('div')
                newSet.classList.add('card', 'my-2')

                let setTitle = document.createElement('div')
                setTitle.classList.add('card-title', 'd-flex', 'justify-content-between', 'mt-4', 'mx-4')

                let titleTitle = document.createElement('h5')
                titleTitle.classList.add('card-title')
                titleTitle.innerHTML = headers[i]

                let titleDropdown = document.createElement('div')
                titleDropdown.classList.add('dropdown')

                let dropdownToggle = document.createElement('a')
                dropdownToggle.role = "button"
                dropdownToggle.setAttribute("data-bs-toggle", "dropdown")
                dropdownToggle.setAttribute("aria-expanded", "false")
                dropdownToggle.innerText = '...'

                let dropdownMenu = document.createElement('ul')
                dropdownMenu.classList.add('dropdown-menu', 'p-3')

                let editItem = document.createElement('li')
                let deleteItem = document.createElement('li')

                let editButton = document.createElement('button')
                editButton.classList.add('btn', 'bg-body', 'edit')
                editButton.innerText = "Edit"

                let deleteButton = document.createElement('button')
                deleteButton.classList.add('btn', 'bg-body', 'delete')
                deleteButton.type = "button"
                deleteButton.setAttribute("data-bs-toggle", "modal")
                let modal_id = "modal" + i
                let delete_id = "#" + modal_id
                deleteButton.setAttribute("data-bs-target", delete_id)
                deleteButton.innerText = "Delete"

                let setBody = document.createElement('div')
                setBody.classList.add('card-body', 'home-set')

                let bodyTerms = document.createElement('p')
                bodyTerms.classList.add('card-text')
                bodyTerms.innerHTML = set.quantity + ' terms'
                let bodyType = document.createElement('p')
                bodyType.innerHTML = set.type


                newSetCol.append(newSet)
                newSet.append(setTitle)
                newSet.append(setBody)
                setBody.append(bodyTerms)
                bodyTerms.append(bodyType)

                setTitle.append(titleTitle)
                setTitle.append(titleDropdown)
                titleDropdown.append(dropdownToggle)
                titleDropdown.append(dropdownMenu)
                dropdownMenu.append(editItem)
                dropdownMenu.append(deleteItem)
                editItem.append(editButton)
                deleteItem.append(deleteButton)

                // modal
                // let modal = document.createElement('div')
                // modal.classList.add('modal', 'fade')
                // modal.setAttribute("tabindex", "-1")
                // modal.id = modal_id
                //
                // let modalDialog = document.createElement('div')
                // modalDialog.classList.add('modal-dialog')
                //
                // let modalContent = document.createElement('div')
                // modalContent.classList.add('modal-content')
                //
                // let modalHeader = document.createElement('div')
                // modalHeader.classList.add('modal-header')
                //
                // let modalTitle = document.createElement('h1')
                // modalTitle.classList.add('modal-title', 'fs-5')
                // modalTitle.id = modal_id + "label"
                // modalTitle.innerText = "Delete " + headers[i] + "?"
                //
                // let modalClose = document.createElement('button')
                // modalClose.classList.add('btn-close')
                // modalClose.type = "button"
                // modalClose.setAttribute("data-bs-dismiss", "modal")
                // modalClose.setAttribute("aria-label", "Close")
                //
                // let modalBody = document.createElement('div')
                // modalBody.classList.add('modal-body')
                //
                // let modalDelete = document.createElement('button')
                // modalDelete.classList.add('btn', 'btn-light', 'delete')
                // modalDelete.type = 'button'
                //
                // modal.append(modalDialog)
                // modalDialog.append(modalContent)
                // modalContent.append(modalHeader)
                // modalContent.append(modalBody)
                // modalHeader.append(modalTitle)
                // modalHeader.append(modalClose)
                // modalBody.append(modalDelete)
                //
                // document.getElementById('div').append(modal)
                // document.append(modal
                document.getElementById('index-row').append(newSetCol)
            }

            let home_sets = document.getElementsByClassName('home-set')
            for (let i = 0; i < home_sets.length; i++) {
                home_sets[i].addEventListener('click', async function () {
                    await newPage(headers[i], '/quiz', '/terms-preview')
                })
            }

            let edit_buttons = document.getElementsByClassName('edit')
            for (let i = 0; i < edit_buttons.length; i++) {
                edit_buttons[i].addEventListener('click', async function (e) {
                    e.stopPropagation()
                    await newPage(headers[i], '#', '/edit')

                })
            }

            let del_buttons = document.getElementsByClassName('delete')
            for (let i = 0; i < del_buttons.length; i++) {
                del_buttons[i].addEventListener('click', async function (e) {
                    e.stopPropagation()
                    await deleteJson(headers[i])
                    location.reload() //works for now fix later
                })
            }


        } catch (error) {
            console.error('Error:', error)
        }
    }

    async function getSets() {
        const response = await fetch('/list-jsons')
        if (!response.ok) {
            throw new Error('Network response was not ok')
        }
        let data = await response.json()
        let filelist = await parseArray(data)
        return filelist
    }

    async function parseArray(filelist) {
        for (let i = 0; i < filelist.length; i++) {
            filelist[i] = filelist[i].replace(".json", "")
            if (filelist[i] == '.DS_Store') {
                filelist.splice(i, i)
                i--
            }
        }
        console.log(filelist)
        return filelist
    }

    async function openJson(name) {
        let filename = name + ".json"
        const response = await fetch('/open/' + filename)
        if (!response.ok) {
            throw new Error('Network response was not ok')
        }
        let data = await response.json()
        return data
    }

    async function newPage(name, qhref, fhref) {
        try {
            let data = await openJson(name)
            console.log(data.type)
            if (data.type == 'Quiz') {
                await localStorage.setItem('quiz', JSON.stringify(data))
                window.location.href = qhref
            } else {
                await localStorage.setItem('set', JSON.stringify(data))
                window.location.href = fhref
            }
        } catch (error) {
            console.log("Error: ", error)
        }
    }

    async function deleteJson(name) {
        let filename = name + '.json'
        const response = await fetch('/delete/' + filename)
        if (!response.ok) {
            throw new Error('Network response not ok')
        }
        console.log(response)
        return response
    }
</script>
{% endblock %}